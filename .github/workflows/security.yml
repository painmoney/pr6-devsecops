name: Security CI/CD Pipeline

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: Run Bandit SAST
      id: bandit
      run: |
        echo "üîç –ó–∞–ø—É—Å–∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."
        bandit -r . -c .bandit.yml -f json -o bandit-report.json || true
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
        if [ -f bandit-report.json ]; then
          CRITICAL_COUNT=$(python -c "
          import json
          with open('bandit-report.json') as f:
              data = json.load(f)
          critical = sum(1 for issue in data.get('results', []) 
                       if issue.get('issue_severity') == 'HIGH')
          print(critical)
          ")
          
          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "‚ùå –ù–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏: $CRITICAL_COUNT"
            echo "–î–µ—Ç–∞–ª–∏:"
            bandit -r . -c .bandit.yml
            exit 1
          else
            echo "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
          fi
        fi
    
    - name: Scan dependencies for vulnerabilities
      run: |
        echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏..."
        pip install safety
        safety check --full-report || true
    
    - name: Run security tests
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ security-—Ç–µ—Å—Ç–æ–≤..."
        python -m pytest tests/test_security.py -v
    
    - name: Check for debug mode
      id: debug_check
      run: |
        echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ debug —Ä–µ–∂–∏–º–∞..."
        if grep -r "debug\s*=\s*True" . --include="*.py" | grep -v test | grep -v "#"; then
          echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω debug=True –≤ production –∫–æ–¥–µ!"
          exit 1
        else
          echo "‚úÖ Debug —Ä–µ–∂–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        fi
    
    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4  # –û–ë–ù–û–í–õ–ï–ù–û –î–û v4!
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.txt
        retention-days: 7

  deploy:
    needs: security-scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && success()
    
    steps:
    - name: Deploy to production
      run: |
        echo "üöÄ –í—Å–µ security –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!"
        echo "–ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é –≤ production."
        echo "–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–º–∞–Ω–¥–∞ –¥–µ–ø–ª–æ—è (Heroku, Docker, etc.)"